// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum UserRole {
  CANDIDATE
  RECRUITER
  ADMIN
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum LanguageLevel {
  BASIC
  INTERMEDIATE
  ADVANCED
  NATIVE
}

enum ExperienceLevel {
  INTERN
  FRESHER
  JUNIOR
  MIDDLE
  SENIOR
  LEAD
  MANAGER
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
  FREELANCE
}

enum CompanySize {
  STARTUP
  SMALL
  MEDIUM
  LARGE
  ENTERPRISE
}

enum AppStatus {
  PENDING
  REVIEWING
  ACCEPTED
  REJECTED
  CANCELLED
}

enum NotificationType {
  APPLICATION_RECEIVED
  APPLICATION_STATUS_CHANGED
  COMPANY_REGISTRATION
  COMPANY_APPROVED
  COMPANY_REJECTED
  COMPANY_UPDATE_PENDING
  COMPANY_INVITATION
  INVITATION_REJECTED
  MEMBER_JOINED
  MEMBER_REMOVED
  JOB_POSTED
  JOB_APPROVED
  JOB_REJECTED
  JOB_UPDATE_PENDING
  WELCOME
}

enum Status {
  DRAFT
  ACTIVE
  INACTIVE
  LOCKED
  PENDING
  SUSPENDED
}

enum CompanyRole {
  OWNER
  MANAGER
  RECRUITER
  VIEWER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED
  EXPIRED
}

// ============================================
// MODELS
// ============================================

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  fullName     String?
  phoneNumber  String?
  gender       Gender?
  role         UserRole  @default(CANDIDATE)
  dateOfBirth  DateTime?
  status       Status    @default(ACTIVE)
  lastLoginAt  DateTime?
  avatarUrl    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  cvs                 CV[]
  companyMember       CompanyMember? // 1 User chỉ thuộc 1 Company (optional)
  applications        Application[]
  savedJobs           SavedJob[]
  savedCVs            SavedCV[] // CVs được recruiter lưu
  notifications       Notification[]
  invitationsReceived CompanyMemberInvitation[] @relation("InvitedUser")
  invitationsSent     CompanyMemberInvitation[] @relation("Inviter")

  @@map("users")
}

model Company {
  id          String       @id @default(uuid())
  name        String
  website     String?
  description String?
  industry    String?
  companySize CompanySize?
  foundedYear Int?
  address     String?
  phone       String?
  email       String?
  logoUrl     String?
  bannerUrl   String?
  status      Status       @default(ACTIVE)
  documentUrl String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  members      CompanyMember[]
  invitations  CompanyMemberInvitation[]
  jobs         Job[]

  @@map("companies")
}

model CompanyMember {
  id          String      @id @default(uuid())
  userId      String      @unique // 1 User chỉ có 1 CompanyMember (one-to-one)
  companyId   String
  companyRole CompanyRole @default(RECRUITER)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("company_members")
}

model CompanyMemberInvitation {
  id             String           @id @default(uuid())
  companyId      String
  userId         String // User được mời
  inviterId      String // User mời
  role           CompanyRole
  status         InvitationStatus @default(PENDING)
  expiresAt      DateTime?
  notificationId String?          @unique // Link đến Notification
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Relations
  company      Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user         User          @relation("InvitedUser", fields: [userId], references: [id], onDelete: Cascade)
  inviter      User          @relation("Inviter", fields: [inviterId], references: [id], onDelete: Cascade)
  notification Notification? @relation(fields: [notificationId], references: [id], onDelete: SetNull)

  // Không cần unique constraint - dựa vào business logic để check duplicate PENDING
  @@map("company_member_invitations")
}

model CV {
  id              String    @id @default(uuid())
  userId          String
  title           String
  isMain          Boolean   @default(false)
  fullName        String?
  email           String?
  phoneNumber     String?
  dateOfBirth     DateTime?
  gender          Gender?
  address         String?
  currentPosition String?
  summary         String?   @db.Text
  objective       String?   @db.Text
  lastGeneratedAt DateTime?
  titleEmbedding      Json? // Vector embedding for CV title
  skillsEmbedding     Json? // Vector embedding for CV skills
  experienceEmbedding Json? // Vector embedding for CV experience
  contentHash         String? // Hash of CV content to check if embedding needs update
  isOpenForJob    Boolean   @default(false)
  templateId      String?   // Template mặc định cho CV (optional)
  pdfUrl          String?   // URL của file PDF đã generate và lưu trên storage
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  template        CVTemplate?         @relation(fields: [templateId], references: [id], onDelete: SetNull)
  skills          CVSkill[]
  educations      Education[]
  certifications  Certification[]
  workExperiences WorkExperience[]
  projects        Project[]
  languages       Language[]
  achievements    Achievement[]
  activities      Activity[]
  references      Reference[]
  applications    Application[]
  recommendJobs   RecommendJobforCV[]
  savedBy         SavedCV[] // Recruiters đã lưu CV này

  @@map("cvs")
}

model CVSkill {
  id                String     @id @default(uuid())
  cvId              String
  skillName         String
  level             SkillLevel
  yearsOfExperience Int?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  // Relations
  cv CV @relation(fields: [cvId], references: [id], onDelete: Cascade)

  @@map("cv_skills")
}

model Education {
  id          String    @id @default(uuid())
  cvId        String
  institution String
  degree      String?
  startDate   DateTime?
  endDate     DateTime?
  description String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  cv CV @relation(fields: [cvId], references: [id], onDelete: Cascade)

  @@map("educations")
}

model Certification {
  id          String    @id @default(uuid())
  cvId        String
  name        String
  issuer      String?
  acquiredAt  DateTime?
  description String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  cv CV @relation(fields: [cvId], references: [id], onDelete: Cascade)

  @@map("certifications")
}

model WorkExperience {
  id          String    @id @default(uuid())
  cvId        String
  title       String
  company     String
  startDate   DateTime?
  endDate     DateTime?
  description String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  cv CV @relation(fields: [cvId], references: [id], onDelete: Cascade)

  @@map("work_experiences")
}

model Project {
  id          String    @id @default(uuid())
  cvId        String
  name        String
  description String?   @db.Text
  startDate   DateTime?
  endDate     DateTime?
  url         String?
  role        String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  cv CV @relation(fields: [cvId], references: [id], onDelete: Cascade)

  @@map("projects")
}

model Language {
  id          String        @id @default(uuid())
  cvId        String
  name        String
  level       LanguageLevel
  description String?       @db.Text
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  cv CV @relation(fields: [cvId], references: [id], onDelete: Cascade)

  @@map("languages")
}

model Achievement {
  id          String    @id @default(uuid())
  cvId        String
  title       String
  description String?   @db.Text
  acquiredAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  cv CV @relation(fields: [cvId], references: [id], onDelete: Cascade)

  @@map("achievements")
}

model Activity {
  id           String    @id @default(uuid())
  cvId         String
  title        String
  organization String?
  startDate    DateTime?
  endDate      DateTime?
  description  String?   @db.Text
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  cv CV @relation(fields: [cvId], references: [id], onDelete: Cascade)

  @@map("activities")
}

model Reference {
  id          String   @id @default(uuid())
  cvId        String
  name        String
  position    String?
  company     String?
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  cv CV @relation(fields: [cvId], references: [id], onDelete: Cascade)

  @@map("references")
}

model Salary {
  id           String   @id @default(uuid())
  jobId        String   @unique
  minAmount    Decimal? @db.Decimal(12, 2)
  maxAmount    Decimal? @db.Decimal(12, 2)
  currency     String?  @default("VND")
  isNegotiable Boolean  @default(false)
  hideAmount   Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@map("salaries")
}

model Job {
  id               String           @id @default(uuid())
  companyId        String
  title            String
  description      String           @db.Text
  location         String?
  industry         String?
  experienceLevel  ExperienceLevel?
  type             JobType?
  titleEmbedding      Json? // Vector embedding for job title
  skillsEmbedding     Json? // Vector embedding for job skills
  requirementEmbedding Json? // Vector embedding for job requirements
  contentHash         String? // Hash of job content to check if embedding needs update
  urgent           Boolean          @default(false)
  status           Status           @default(ACTIVE)
  expiresAt        DateTime?
  applicationCount Int              @default(0)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Relations
  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  salary          Salary?
  skills          JobSkill[]
  benefits        JobBenefit[]
  requirements    JobRequirement[]
  applications    Application[]
  savedJobs       SavedJob[]
  similarJobs     SimilarJob[]        @relation("JobSimilarities")
  similarToJobs   SimilarJob[]        @relation("SimilarJobs")
  recommendForCVs RecommendJobforCV[]

  @@map("jobs")
}

model JobBenefit {
  id          String   @id @default(uuid())
  jobId       String
  title       String
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@map("job_benefits")
}

model JobRequirement {
  id          String   @id @default(uuid())
  jobId       String
  title       String
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@map("job_requirements")
}

model JobSkill {
  id                String     @id @default(uuid())
  jobId             String
  skillName         String
  level             SkillLevel
  yearsOfExperience Int?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  // Relations
  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@map("job_skills")
}

model SimilarJob {
  id           String   @id @default(uuid())
  jobId        String
  similarJobId String
  similarity   Float
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  job        Job @relation("JobSimilarities", fields: [jobId], references: [id], onDelete: Cascade)
  similarJob Job @relation("SimilarJobs", fields: [similarJobId], references: [id], onDelete: Cascade)

  @@unique([jobId, similarJobId])
  @@map("similar_jobs")
}

model Application {
  id          String    @id @default(uuid())
  userId      String
  cvId        String
  jobId       String
  status      AppStatus @default(PENDING)
  coverLetter String?   @db.Text
  notes       String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  cv   CV   @relation(fields: [cvId], references: [id], onDelete: Cascade)
  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // Note: Không có unique constraint để cho phép apply lại sau khi withdraw (CANCELLED)
  // Có thể có nhiều applications cho cùng userId + jobId, nhưng chỉ 1 active (không CANCELLED)
  @@map("applications")
}

model SavedJob {
  id        String   @id @default(uuid())
  userId    String
  jobId     String
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([userId, jobId])
  @@map("saved_jobs")
}

model SavedCV {
  id        String   @id @default(uuid())
  userId    String   // Recruiter lưu CV
  cvId      String   // CV được lưu
  notes     String?  @db.Text // Ghi chú của recruiter
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  cv   CV   @relation(fields: [cvId], references: [id], onDelete: Cascade)

  @@unique([userId, cvId])
  @@map("saved_cvs")
}

model RecommendJobforCV {
  id         String   @id @default(uuid())
  cvId       String
  jobId      String
  similarity Float
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  cv  CV  @relation(fields: [cvId], references: [id], onDelete: Cascade)
  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([cvId, jobId])
  @@map("recommend_jobs_for_cv")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String           @db.Text
  isRead    Boolean          @default(false)
  readAt    DateTime?
  expiresAt DateTime?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // Relations
  user       User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  invitation CompanyMemberInvitation?

  @@map("notifications")
}

model CVTemplate {
  id         String   @id @default(uuid())
  name       String
  htmlUrl    String
  previewUrl String?  // Ảnh preview của template (optional)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  cvs        CV[] // CVs sử dụng template này làm mặc định

  @@map("cv_templates")
}
